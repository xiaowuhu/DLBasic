
## 3.8 归一化与权重值还原【电子资源】

从第 3.2 节得到的参考值可以看到，$w$ 是个位数，$b$ 是十位数，所以损失函数形态会是椭圆形的，不利于网络参数训练收敛。根据第 2.5 节的经验，必须先对数据做归一化。

### 3.8.1 样本归一化

由于 $\mathbf X$ 数据有两个特征，所以归一化的方法要有所变化，如【代码：common.DataLoader_3.py】所示，使用了 `axis=0` 参数，这样可以分别对两列特征值做各自的归一化，互不干扰。

```python
    # 归一化训练数据
    def normalize_train_data(self):
        self.x_min = np.min(self.train_x, axis=0)
        self.x_max = np.max(self.train_x, axis=0)
        self.train_x = (self.train_x - self.x_min) / (self.x_max - self.x_min)
        self.y_min = np.min(self.train_y, axis=0)
        self.y_max = np.max(self.train_y, axis=0)
        self.train_y = (self.train_y - self.y_min) / (self.y_max - self.y_min)
```

这样的话，在 `self.x_min, self.x_max` 中就各含有两个值，分别是特征值 $x_1$ 和特征值 $x_2$ 的最小、最大值。

$$
\begin{aligned}
x_{min}&=\begin{bmatrix} \min(x_1) & \min(x_2) \end{bmatrix}\\
x_{max}&=\begin{bmatrix} \max(x_1) & \max(x_2) \end{bmatrix}
\end{aligned}
\tag{3.8.1}
$$

### 3.8.2 归一化后的正规方程解

样本数据归一化后，可以再使用正规方程进行求解，以得到参考值。运行【代码：H3_3_Normalization.py】可以得到归一化后的正规方程计算结果：

```
-- 归一化样本的结果 --
X 的最小值 [50.  2.]
X 的最大值 [150.  20.]
X 的最大值 - 最小值 = [100.  18.]
Y 的最小值 [285.25]
Y 的最大值 [807.89]
Y 的最大值 - 最小值 = [522.64]
-- 归一化样本后的正规方程结果 --
w_1 = 0.9557659528648107
w_2 = -0.08825704035083334
b = 0.030540619858191884
```
归一化后，正规方程解为：$w_1=0.9558, w_2=-0.0883, b=0.0305$。计算预测值前，先归一化预测样本值。把 93 平方米和 15 公里两个特征值带入式

$$
x_{new}=\frac{x-x_{min}}{x_{max} - x_{min}}
\tag{3.8.2}
$$

得到：

$$
x_1=\frac{93-50}{100-50}=0.43, \ \ x_2=\frac{15-2}{20-2}=0.722
\tag{3.8.3}
$$

再带入模型公式：

$$
z = w_1 x_1 + w_2 x_2 + b = 0.9558 \times 0.43 -0.0882 \times 0.7222 + 0.0305 \approx 0.3778
\tag{3.8.4}
$$

用代码可以得到同样的结果：

```
-- 用归一化样本值预测 --
归一化样本特征值: [[93 15]] => [[0.43       0.72222222]]
归一化的预测结果: [[0.37777878]]
```
最后房价预测结果是 0.3778，但这个价格显然不对，不对的原因应该与样本归一化有关。所以接下来需要研究如何把 0.3778 转换成真实的房价值。

### 3.8.3 归一化前后参数值的转换关系

我们先把现有的数据总结一下，从 3.2.2 节和 3.8.2 节分别得到归一化前后的 $w_1、w_2、b$ 值，列在表 3.8.1 中，归一化前的数据称为原始样本。

表 3.8.1 归一化前后正规方程的解

|正规方程的解|$w_1$|$w_2$|$b$|$y$|
|-|-|-|-|-|
|原始样本的参数值 $w_t,b_t$|4.9952|-2.5626|56.57|482.69|
|归一化后的参数值 $w_n,b_n$|0.9558|-0.0883|0.0305|0.3778|


假设原始样本用下标 $t$ 表示，归一化后的样本用下标 $n$ 表示。则有：

$$
x_n = \frac{x_t - x_{min}}{x_{max} - x_{min}}=\frac{x_t - x_{min}}{d_x} 
\tag{3.8.5}
$$

$$
y_n = \frac{y_t - y_{min}}{y_{max} - y_{min}}=\frac{y_t - y_{min}}{d_y} 
\tag{3.8.6}
$$

其中：
$$
\begin{aligned}
d_x &= x_{max} - x_{min}=[150,20]-[50,2]=[100, 18] \\
d_y &= y_{max} - y_{min}=807.89-285.25=522.64
\end{aligned}
\tag{3.8.7}
$$

在归一化之前，有：

$$
x_t w_t + b_t = y_t 
\tag{3.8.8}
$$

在归一化之后，有：

$$
x_n w_n + b_n=y_n 
\tag{3.8.9}
$$

把 $y_t、y_n$ 带入式（3.8.6）：

$$
x_n w_n + b_n = \frac{x_t w_t + b_t - y_{min}}{d_y} 
\tag{3.8.10}
$$

再把式（3.8.5）带入式（3.8.10）左侧：

$$
\frac{x_t - x_{min}}{d_x} w_n + b_n = \frac{x_t w_t + b_t - y_{min}}{d_y} 
\tag{3.8.11}
$$

在式（3.8.11）中把两侧转换成 $x_t$ 的表达式：

$$
\frac{w_n}{d_x} x_t + (b_n-\frac{w_n x_{min}}{d_x}) = \frac{w_t}{d_y}x_t +\frac{b_t - y_{min}}{d_y} 
\tag{3.8.12}
$$

由于式（3.8.12）中 $x_t$ 是变量，其它的部分都是常量，所以左右两侧关于 $x_t$ 的表达式应该相等，关于常量的表达式也应该相等，这样就得到两个等式：

$$
\begin{cases}
\frac{w_n}{d_x} = \frac{w_t}{d_y}
\\
b_n-\frac{w_n x_{min}}{d_x} = \frac{b_t - y_{min}}{d_y}
\end{cases}
\Rightarrow
\begin{cases}
w_t = \frac{w_n}{d_x} d_y
\\
b_t= (b_n - \frac{w_n x_{min}}{d_x})d_y+y_{min}
\end{cases}
\tag{3.8.13}
$$

我们把表 3.8.1 中的数据带入式（3.8.13）验证一下：

$$
\begin{aligned}
w_t&=\frac{w_n}{d_x}d_y = \frac{[0.9558,-0.0883]}{[100,18]}\times 522.64 \approx [4.9952,-2.5626]
\\
b_t &= (b_n - \frac{w_n x_{min}}{d_x})d_y+y_{min}
\\
&=(0.0305-\frac{[0.9558,-0.0883][50,2]}{[100,18]})\times 522.64+285.25
\\
&=(0.0305-\frac{0.9558\times 50}{100}+\frac{0.0883\times 2}{18})\times 522.64+285.25 
\\
&\approx 56.57
\end{aligned}
\tag{3.8.14}
$$

可以看到 $w_t$ 和 $b_t$ 的结果与表 3.8.1 中的第一行一致，这说明式（3.8.13）所示的归一化前后的参数转换关系正确。即，假设我们用神经网络解得 $w_n、b_n$ 后，可以用式（3.8.13）转换成为真实的 $w_t、b_t$。

